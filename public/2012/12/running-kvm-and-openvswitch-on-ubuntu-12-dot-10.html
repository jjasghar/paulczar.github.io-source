
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Running KVM and Openvswitch on Ubuntu 12.10 - tech.paulcz.net</title>
    <meta name="author" content="Paul Czarkowski">
    
	<meta name="description" content="I&#8217;ve got an aging VMWare ESXi 4.0 server that needs to be replaced with something a little more modern and flexing. Obviously at home I don&# &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="tech.paulcz.net" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35638296-3']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Paul Czarkowski
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/paulczar" class="github" title="Github"></a>
  </li>
  
  
  <!-- Google Plus -->
  <li>
  <a href="http://plus.google.com/username.taken@gmail.com?rel=author" class="google" title="Google+"></a>
  </li>
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/pczarkowski" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">Running KVM and Openvswitch on Ubuntu 12.10</h2>
	<div class="entry-content"><p>I&#8217;ve got an aging VMWare ESXi 4.0 server that needs to be replaced with something a little more modern and flexing.   Obviously at home I don&#8217;t need all the cool features that licensed VMWare comes with,  but I do want more than just the basic free version.</p>

<p>After a few weeks of installing and testing alternatives  ( I&#8217;d really love to run openstack,  but it&#8217;s just not worth it at home for a single box ) I&#8217;ve settled on Ubuntu 12.10 server running KVM and Openvswitch.</p>

<p>After installing Ubuntu 12.10 I did the following to get KVM up and running&#8230;   I cribbed this mostly from <a href="http://blog.allanglesit.com/2012/10/linux-kvm-ubuntu-12-10-with-openvswitch/">blog.allanglesit.com</a>.</p>

<!--more-->


<p><strong>Install updates and Pre-requisites</strong></p>

<p>First of all, make sure Ubuntu is fully up to date:
<em>sudo to root as pretty much every command here needs to be run as root</em></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo bash
</span><span class='line'>apt-get update
</span><span class='line'>apt-get upgrade
</span></code></pre></td></tr></table></div></figure>


<p>Now we can go ahead and install the necessary packages:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>apt-get -y install aptitude apt-show-versions ntp ntpdate vim kvm <span class="se">\</span>
</span><span class='line'> libvirt-bin vlan virtinst virt-manager virt-viewer openssh-server <span class="se">\</span>
</span><span class='line'> iperf pv openvswitch-controller openvswitch-brcompat <span class="se">\</span>
</span><span class='line'> openvswitch-switch nfs-common
</span></code></pre></td></tr></table></div></figure>


<p><strong>Kill off the default libvirt bridge and nuke ebtables</strong></p>

<p>We want to delete the default libvirt interface and we don&#8217;t need ebtables so we&#8217;ll get rid of that.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>virsh net-destroy default
</span><span class='line'>virsh net-autostart --disable default
</span><span class='line'>service libvirt-bin stop
</span><span class='line'>service qemu-kvm stop
</span><span class='line'>aptitude purge -y ebtables
</span><span class='line'>service openvswitch-switch restart
</span><span class='line'>service openvswitch-controller restart
</span></code></pre></td></tr></table></div></figure>


<p><strong>Configure network interfaces</strong></p>

<p>We&#8217;ll be using just a single interface which will be used for both the bridge and the host itself.    We will also be bridging that network into the the vswitch and then configuring an interface for the host OS.    The network configuration will look something like this:</p>

<figure class='code'><figcaption><span>/etc/network/interfaces </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># The loopback network interface
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'># The primary network interface - bridge!
</span><span class='line'>auto eth0
</span><span class='line'>iface eth0 inet manual
</span><span class='line'>up ifconfig $IFACE 0.0.0.0 up
</span><span class='line'>down ifconfig $IFACE down
</span><span class='line'>    
</span><span class='line'># The host OS network interface
</span><span class='line'># DNS settings here,  12.10 resets resolv.conf on reboot.
</span><span class='line'>auto ovsbr0p1
</span><span class='line'>iface ovsbr0p1 inet static
</span><span class='line'>address 192.168.50.10
</span><span class='line'>netmask 255.255.255.0
</span><span class='line'>gateway 192.168.50.1
</span><span class='line'>dns-nameservers 192.168.50.1
</span><span class='line'>dns-search example.com</span></code></pre></td></tr></table></div></figure>


<p><strong>Configure the openvswitch network</strong></p>

<p>Now we need to configure the network on the openvswitch.     We need to define the bridge, connect it to the uplink interface and create a port for the host OS.</p>

<p><em>note: if you&#8217;re doing this via SSH it will probably break your session</em></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ovs-vsctl add-br ovsbr0
</span><span class='line'>ovs-vsctl add-port ovsbr0 eth0
</span><span class='line'>ovs-vsctl add-port ovsbr0 ovsbr0p1 -- <span class="nb">set </span>interface ovsbr0p1 <span class="nb">type</span><span class="o">=</span>internal
</span><span class='line'>reboot
</span></code></pre></td></tr></table></div></figure>


<p><strong>Modify network service sleep times</strong></p>

<p>That took forever to boot.    We can fix that by modifying sleeps in /etc/init/failsafe.conf and reboot again to make sure it helped.</p>

<p>Change :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$PLYMOUTH message --text="Waiting for network configuration..." || :
</span><span class='line'>sleep 40
</span><span class='line'>$PLYMOUTH message --text="Waiting up to 60 more seconds for network configuration..." || :
</span><span class='line'>sleep 59
</span><span class='line'>$PLYMOUTH message --text="Booting system without full network configuration..." || :</span></code></pre></td></tr></table></div></figure>


<p>To :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$PLYMOUTH message --text="Waiting for network configuration..." || :
</span><span class='line'>sleep 1
</span><span class='line'>$PLYMOUTH message --text="Waiting up to 60 more seconds for network configuration..." || :
</span><span class='line'>sleep 1
</span><span class='line'>$PLYMOUTH message --text="Booting system without full network configuration..." || :</span></code></pre></td></tr></table></div></figure>


<p><strong>LVM configure</strong></p>

<p>We&#8217;re going to also use LVM to for the KVM virtual machines to use as storage.    I have a pair of 500g disks in a software raid1 which I&#8217;ll use for this.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pvcreate /dev/md0
</span><span class='line'>vgcreate data-disk /dev/md0
</span><span class='line'>lvcreate -L 10G -n ISO data-disk
</span><span class='line'>mkfs.ext4 /dev/data-disk/ISO
</span><span class='line'>mkdir -p /data-disk/ISO
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;/dev/data-disk/ISO /data-disk/ISO defaults    ext4    0 0&quot;</span> &gt;&gt; /etc/fstab
</span><span class='line'>mount -a
</span></code></pre></td></tr></table></div></figure>


<p><strong>Create VM</strong></p>

<p>Now we can go ahead and create our first VM.   I&#8217;ve already downloaded the Ubuntu ISO to /data-disk/ISO</p>

<p><em>note: virt-install does not support setting a virtualport type of openvswitch yet .. so we have to trick it</em></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lvcreate -L 8G -n VM-UbuntuTest data-disk
</span><span class='line'>virt-install --name UbuntuTest --hvm --noautoconsole --ram 1024 <span class="se">\</span>
</span><span class='line'>--disk <span class="nv">path</span><span class="o">=</span>/dev/data-disk/VM-UbuntuTest --nonetworks --vnc <span class="se">\</span>
</span><span class='line'>--os-type<span class="o">=</span>linux --os-variant<span class="o">=</span>ubuntuquantal <span class="se">\</span>
</span><span class='line'>--cdrom /data-disk/ISO/ubuntu-12.10-server-amd64.iso
</span></code></pre></td></tr></table></div></figure>


<p>set up the networking by editing the VM&#8217;s XML and adding a network interface stanza just before the &lt;/devices>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>virsh edit UbuntuTest
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span>
</span><span class='line'> <span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">&#39;ovsbr0&#39;</span><span class="nt">/&gt;</span>
</span><span class='line'> <span class="nt">&lt;virtualport</span> <span class="na">type=</span><span class="s">&#39;openvswitch&#39;</span> <span class="nt">/&gt;</span>
</span><span class='line'> <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/interface&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The VM will need to be reset to pick up the network change,  however that will cause it to drop the ISO mount.  We can either continue through with the OS install without networking or reset the VM and then re-attach the ISO as a CD.    I connected to it from my desktop using the VirtualMachineManager GUI to do that but you could use virsh commands if you want to stick to CLI.</p>
</div>

<div class="meta">
	
		<span class="comments"><a href="/2012/12/running-kvm-and-openvswitch-on-ubuntu-12-dot-10.html#disqus_thread">Comments</a></span>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2014

    Paul Czarkowski
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'tech-paulcz';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://paulczar.github.com/2012/12/running-kvm-and-openvswitch-on-ubuntu-12-dot-10.html';
        var disqus_url = 'http://paulczar.github.com/2012/12/running-kvm-and-openvswitch-on-ubuntu-12-dot-10.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
