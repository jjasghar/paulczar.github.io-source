
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Running DEIS.IO on Rackspace Cloud - tech.paulcz.net</title>
    <meta name="author" content="Paul Czarkowski">
    
	<meta name="description" content="I recently did a presentation at the Cloud Austin meetup titled Docking with Unicorns about new PAAS on the block DEIS. Building out DEIS is quite &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="tech.paulcz.net" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35638296-3']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Paul Czarkowski
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/paulczar" class="github" title="Github"></a>
  </li>
  
  
  <!-- Google Plus -->
  <li>
  <a href="http://plus.google.com/username.taken@gmail.com?rel=author" class="google" title="Google+"></a>
  </li>
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/pczarkowski" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">Running DEIS.IO on Rackspace Cloud</h2>
	<div class="entry-content"><p>I recently did a presentation at the Cloud Austin meetup titled <a href="http://tech.paulcz.net/presentation-cloud-austin-deis/#/">Docking with Unicorns</a> about new PAAS on the block <a href="http://deis.io">DEIS</a>.   Building out DEIS is quite easy,  make more easy by some tight integration they have with Rackspace Cloud.    If you&#8217;re interested in what deis is go through my slides linked above, and the documentation on their website.    If you want to build out an environment to kick the tires a bit,  then click &#8216;Read on&#8217; below and follow me down the rabbit hole.</p>

<!--more-->


<h2>Chef setup</h2>

<p>Chef offers a free hosted service for up to five servers.  That&#8217;s plenty for this exercise so go to the <a href="https://www.getchef.com/account">registration page</a> and create yourself a user.  At some point it will prompt you to generate and save a key, do that and download it.</p>

<p>Once you have signed up you can download a knife config file and generate a validation key from the <a href="https://manage.opscode.com/organizations">Organizations</a> page.  We can save those down and then move them to a local working directory.</p>

<p><img src="https://lh5.googleusercontent.com/-3R-Z-bRi_s0/UwpipiLhhWI/AAAAAAAAN0Q/W6q_Rb7NFy8/w1240-h663-no/opscode-org-page.png" alt="chef org setup" /></p>

<h3>Prepare Working Environment</h3>

<p>Create a <code>~/paas</code> working directory and configure your local chef tools like this ( change the Download location to match the files you downloaded above ) :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p ~/paas/.chef
</span><span class='line'>$ cd ~/paas
</span><span class='line'>$ mv ~/Downloads/&lt;username&gt;.pem .chef/
</span><span class='line'>$ mv ~/Downloads/knife.rb .chef/
</span><span class='line'>$ mv ~/Downloads/&lt;username&gt;-validator.pem .chef/
</span></code></pre></td></tr></table></div></figure>


<h3>Clone the Deis Repository</h3>

<p>Clone the deis project into your paas working directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/paas
</span><span class='line'>$ git clone https://github.com/opdemand/deis.git
</span><span class='line'>Cloning into 'deis'...
</span><span class='line'>remote: Reusing existing pack: 5651, done.
</span><span class='line'>Receiving objects: 100% (5651/5651), 2.16 MiB | 1.37 MiB/s, done.
</span><span class='line'>remote: Total 5651 (delta 0), reused 0 (delta 0)
</span><span class='line'>Resolving deltas: 100% (3131/3131), done.
</span><span class='line'>Checking connectivity... done
</span></code></pre></td></tr></table></div></figure>


<h3>Install Pre-reqs</h3>

<p>Assuming you have a working <code>Ruby 1.9.3+</code> and the <code>bundler</code> gem installed you should be able to use the <code>Gemfile</code> from the deis project to ensure you have all the necessary tools:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/paas/deis
</span><span class='line'>$ bundle install
</span><span class='line'>bundle install
</span><span class='line'>Fetching gem metadata from https://rubygems.org/.......
</span><span class='line'>Fetching additional metadata from https://rubygems.org/..
</span><span class='line'>Using i18n (0.6.9)
</span><span class='line'>Using multi_json (1.8.4)
</span><span class='line'>Using activesupport (3.2.16)
</span><span class='line'>Using addressable (2.3.5)
</span><span class='line'>...
</span><span class='line'>Using bundler (1.5.2)
</span><span class='line'>Your bundle is complete!
</span><span class='line'>Use `bundle show [gemname]` to see where a bundled gem is installed.</span></code></pre></td></tr></table></div></figure>


<p><em>I had some errors installing the eventmachine gem and had to follow <a href="https://github.com/gitlabhq/gitlabhq/issues/1051#issuecomment-9176547">this fix</a> to get bundle install to work</em></p>

<h3>Test Chef Connectivity</h3>

<p>To make sure we configured chef correctly and installed knife as part of the bundle we can run a quick knife command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle exec knife client list
</span><span class='line'>&lt;USERNAME&gt;-validator</span></code></pre></td></tr></table></div></figure>


<h3>Create an Environment for Deis</h3>

<p>Deis is currently hardcoded to use the <code>_default</code> chef environment.    There is a current <a href="https://github.com/opdemand/deis/issues/523">issue</a> on their github to resolve this.   Once that is done I&#8217;ll update these instructions to create a <code>deis</code> environment.</p>

<h3>Upload the Deis Cookbooks</h3>

<p>If that went well we can upload our cookbooks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd ~/paas/deis
</span><span class='line'>$ bundle exec berks install
</span><span class='line'>Installing apt (2.3.8) from site: 'http://cookbooks.opscode.com/api/v1/cookbooks'
</span><span class='line'>Installing docker (0.31.0) from site: 'http://cookbooks.opscode.com/api/v1/cookbooks'
</span><span class='line'>Installing rsyslog (1.10.2) from site: 'http://cookbooks.opscode.com/api/v1/cookbooks'
</span><span class='line'>Installing sudo (2.3.0) from site: 'http://cookbooks.opscode.com/api/v1/cookbooks'
</span><span class='line'>...
</span><span class='line'>$ bundle exec berks upload
</span><span class='line'>Using apt (2.3.8)
</span><span class='line'>Using docker (0.31.0)
</span><span class='line'>Using rsyslog (1.10.2)
</span><span class='line'>Using sudo (2.3.0)
</span><span class='line'>Installing deis (0.5.1) from git: 'https://github.com/opdemand/deis-cookbook.git' with branch: 'master' at ref: '6361706a1d3245d2a061ed55f5dd4b7cb60d5e5c'
</span><span class='line'>Using git (2.7.0)
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h3>Create Deis Databags</h3>

<p>Deis uses some databags to help manage application state.  We can create them like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle exec knife data bag create deis-formations
</span><span class='line'>Created data_bag[deis-formations]
</span><span class='line'>$ bundle exec knife data bag create deis-apps
</span><span class='line'>Created data_bag[deis-apps]</span></code></pre></td></tr></table></div></figure>


<h2>Prepare Infrastructure</h2>

<p>I&#8217;m using Rackspace cloud servers for this as I have the (http://developer.rackspace.com/blog/developer-love-welcome-to-the-rackspace-cloud-developer-discount.html)[Rackspace Developer Discount] which is enough discount to host this for free.</p>

<p>Since Deis will want your rackspace credentials to configure worker nodes I recomment creating a user under (https://mycloud.rackspace.com/account#users/create)[User Management] in your account to use for this.</p>

<h3>Create a Cloud Load Balancer</h3>

<p>Log into mycloud.rackspace.com and click on the (https://mycloud.rackspace.com/load_balancers)[Load Balancers] button.  Select the Dallas Region (DFW) and hit <code>Create Load Balancer</code>.</p>

<ul>
<li>Set the Name to <code>deis</code> and check the region is set to <code>Dallas (DFW)</code> and hit <code>Create Load Balancer</code></li>
</ul>


<p><img src="https://lh4.googleusercontent.com/-E4cZvoKWlYU/Uwpiqr9xOKI/AAAAAAAAN0o/P3vGqPC8A98/w793-h592-no/rackspace-create-lb.png" alt="creating load balancer" /></p>

<ul>
<li>Take note of the public IP of the Load Balancer, we&#8217;ll need it later.</li>
</ul>


<p><img src="https://lh4.googleusercontent.com/-ORvf6nzEduU/Uwpiqk5eP0I/AAAAAAAAN0k/WZ-NaJn3eJg/w770-h567-no/rackspace-lb.png" alt="load balancer created" /></p>

<h3>Wildcard DNS</h3>

<p>Deis&#8217; proxy layer requires you to set up Wildcard DNS to point to your proxy layer.  There are many ways to achieve this here are two options:</p>

<ol>
<li><p>Rackspace Cloud DNS can host wildcard DNS entries, if you already have DNS hosted by rackspace using Cloud DNS simply add an A record for <code>*.deis</code> under your domain and point it to the IP of your load balancer.</p></li>
<li><p>The (http://xip.io)[xip.io] domain does wildcard DNS based on your IP.  We can use this with our Cloud Load Balancer to load balance our applications.   My Load Balancer has a public IP of <code>50.56.167.26</code> therefore my wildcard domain will be <code>50.56.167.26.xip.io</code>.   Remember this.</p></li>
</ol>


<h3>Configure Knife for Rackspace</h3>

<p>The bundle install above already installed the rackspace knife plugin so we just need to add some details to <code>.chef/knife.rb</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &lt;&lt;'EOF' &gt;&gt; $HOME/.chef/knife.rb
</span><span class='line'>knife[:rackspace_api_username] = "#{ENV['OS_USERNAME']}"
</span><span class='line'>knife[:rackspace_api_key]      = "#{ENV['OS_PASSWORD']}"
</span><span class='line'>knife[:rackspace_version]      = 'v2'
</span><span class='line'>knife[:rackspace_region]       = :dfw
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<h3>Install Rackspace Nova Client</h3>

<p>We also need the Nova client:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pip install rackspace-novaclient
</span><span class='line'>$ cat &lt;&lt;'EOF' &gt;&gt; ~/paas/.chef/openrc
</span><span class='line'>export OS_AUTH_URL=https://identity.api.rackspacecloud.com/v2.0/
</span><span class='line'>export OS_AUTH_SYSTEM=rackspace
</span><span class='line'>export OS_REGION_NAME=DFW
</span><span class='line'>export OS_USERNAME=&lt;RACKSPACE_USERNAME&gt;
</span><span class='line'>export NOVA_RAX_AUTH=1
</span><span class='line'>export OS_PASSWORD=&lt;RACKSPACE_API_KEY&gt;
</span><span class='line'>export OS_NO_CACHE=1
</span><span class='line'>export OS_TENANT_NAME=&lt;RACKSPACE_USERNAME&gt;
</span><span class='line'>EOF
</span><span class='line'>$ source ~/paas/.chef/openrc</span></code></pre></td></tr></table></div></figure>


<h3>Test Rackspace Connectivity</h3>

<p>Make sure you can connect to Rackspace with Knife:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle exec knife rackspace server list
</span><span class='line'>Instance ID  Name  Public IP  Private IP  Flavor  Image  State</span></code></pre></td></tr></table></div></figure>


<p>Make sure you can connect to Rackspace with nova:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nova list
</span><span class='line'>+--------------------------------------+-----------------+--------+------------+-------------+----------------------------------------------------------------------------------------+
</span><span class='line'>| ID                                   | Name            | Status | Task State | Power State | Networks                                                                               |
</span><span class='line'>+--------------------------------------+-----------------+--------+------------+-------------+----------------------------------------------------------------------------------------+</span></code></pre></td></tr></table></div></figure>


<h2>Build base images for Controller and Nodes.</h2>

<p>This isn&#8217;t strictly necessary,  but will help build your nodes quicker on subsequent builds.</p>

<h3>Launce a new instance:</h3>

<p>If we create a base image and pre-install some software we&#8217;ll get a faster booting system for auto-provisioning:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle exec knife rackspace server create \
</span><span class='line'>  --image '80fbcb55-b206-41f9-9bc2-2dd7aac6c061' \
</span><span class='line'>  --node-name 'deis-base-image' \
</span><span class='line'>  --flavor 'performance1-1'
</span><span class='line'>...
</span><span class='line'>...
</span><span class='line'>Instance ID: 56760bf1-b977-405e-9348-f70b15a14b87
</span><span class='line'>Host ID: 97da00a12312a7e455bda70c6dfab8833953e2a03b081aeedfd68152
</span><span class='line'>Name: deis-base-image
</span><span class='line'>Flavor: 1 GB Performance
</span><span class='line'>Image: Ubuntu 12.04 
</span><span class='line'>Metadata: []
</span><span class='line'>Public DNS Name: 23-253-69-98.xip.io
</span><span class='line'>Public IP Address: 23.253.69.98
</span><span class='line'>Private IP Address: 10.208.101.31
</span><span class='line'>Password: **************</span></code></pre></td></tr></table></div></figure>


<p>Take note of the <code>Instance ID</code>, <code>Public IP Address</code> and <code>Password</code>.  We&#8217;ll need them later.</p>

<h3>Add users / keys to instance</h3>

<p>We&#8217;re going to add our ssh key as well as a local <code>deis-ops</code> user to the image to make it easier to manage and troubleshoot later:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ DEIS_IP=&lt;IP_OF_SERVER&gt;
</span><span class='line'>$ ssh-copy-id root@$DEIS_IP
</span><span class='line'>root@162.242.144.193's password: 
</span><span class='line'>Number of key(s) added: 1
</span><span class='line'>Now try logging into the machine, with:   "ssh 'root@162.242.144.193'"
</span><span class='line'>and check to make sure that only the key(s) you wanted were added.
</span><span class='line'>$ ssh root@$DEIS_IP
</span><span class='line'>Welcome to Ubuntu 12.04.3 LTS (GNU/Linux 3.2.0-55-virtual x86_64)
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>
</span><span class='line'>  System information as of Sun Feb 23 18:34:40 UTC 2014
</span><span class='line'>
</span><span class='line'>  System load:  0.08              Processes:           60
</span><span class='line'>  Usage of /:   5.5% of 19.68GB   Users logged in:     0
</span><span class='line'>  Memory usage: 6%                IP address for eth0: 162.242.144.193
</span><span class='line'>  Swap usage:   0%                IP address for eth1: 10.208.135.114
</span><span class='line'>
</span><span class='line'>  Graph this data and manage this system at https://landscape.canonical.com/
</span><span class='line'>
</span><span class='line'>Last login: Sun Feb 23 18:33:02 2014 from cpe-24-27-47-27.austin.res.rr.com
</span><span class='line'>root@deis-base-image:~# useradd --comment 'deis ops user' --home-dir '/home/deis-ops' \
</span><span class='line'>  --shell '/bin/bash' --create-home deis-ops
</span><span class='line'>root@deis-base-image:~# mkdir -p /home/deis-ops/.ssh && \
</span><span class='line'>   cp /root/.ssh/authorized_keys /home/deis-ops/.ssh/authorized_keys && \
</span><span class='line'>  chown -R deis-ops:deis-ops /home/deis-ops && \
</span><span class='line'>  chmod 0700 /home/deis-ops/.ssh && \
</span><span class='line'>  chmod 0600 /home/deis-ops/.ssh/authorized_keys && \
</span><span class='line'>  echo 'deis-ops ALL=(ALL) NOPASSWD:ALL' &gt; /etc/sudoers.d/deis-ops && \
</span><span class='line'>  chmod 0440 /etc/sudoers.d/deis-ops
</span><span class='line'>root@deis-base-image:~# exit</span></code></pre></td></tr></table></div></figure>


<p>Check that you can log in with these new creds:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh deis-ops@$DEIS_IP
</span><span class='line'>deis$ sudo bash
</span><span class='line'>root@deis$ exit
</span><span class='line'>deis$ exit</span></code></pre></td></tr></table></div></figure>


<h3>Finish preparing node image</h3>

<p>Next we&#8217;re going to update the kernel and prepare the base node image.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh deis-ops@$DEIS_IP 'sudo apt-get update'
</span><span class='line'>$ scp contrib/rackspace/*.sh deis-ops@$DEIS_IP:~/
</span><span class='line'>$ ssh deis-ops@$DEIS_IP 'sudo ~/prepare-node-image.sh'
</span><span class='line'>$ ssh deis-ops@$DEIS_IP 'sudo apt-get install -yq linux-image-generic-lts-raring linux-headers-generic-lts-raring'</span></code></pre></td></tr></table></div></figure>


<h3>Create an image from this server</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nova image-create deis-base-image deis-node-image</span></code></pre></td></tr></table></div></figure>


<p>After a few minutes you should see this response to running <code>nova image-list</code>, if you&#8217;re impatient like me wrap your command with a <code>watch</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ watch 'nova image-list | grep deis'
</span><span class='line'>| df958d26-6515-4dd9-a449-920e74ea93a2 | deis-base-image                                              | ACTIVE | 0fc7f68b-176d-49a9-82ff-2d5893d32acd |
</span></code></pre></td></tr></table></div></figure>


<p>Once the image is active we can move onto the next steps.</p>

<h3>Prepare controller image</h3>

<p>Next we want to prepare the VM for the controller image:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh deis-ops@$DEIS_IP 'sudo ~/prepare-controller-image.sh'
</span><span class='line'>$ ssh deis-ops@$DEIS_IP 'sudo apt-get install -yq linux-image-generic-lts-raring linux-headers-generic-lts-raring'</span></code></pre></td></tr></table></div></figure>


<h3>Create an image from this server</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nova image-create deis-base-image deis-base-image</span></code></pre></td></tr></table></div></figure>


<p>After a few minutes you should see this response to running <code>nova image-list</code>, if you&#8217;re impatient like me wrap your command with a <code>watch</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ watch 'nova image-list | grep deis-node'
</span><span class='line'>| f2236fa6-1e2d-4746-ac87-a3dd6b2de811 | deis-node-image                                              | ACTIVE | 633d5d88-54b3-463c-80fe-c119f4eb33a3 |
</span></code></pre></td></tr></table></div></figure>


<h3>Delete the instance</h3>

<p>No need to keep the instance around and keep paying for it once you have the image:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle exec knife rackspace server list | grep deis  
</span><span class='line'>42899699-68e7-4785-9f49-e0050f86249a  deis-base-image  162.242.144.193  10.208.135.114  performance1-1  80fbcb55-b206-41f9-9bc2-2dd7aac6c061  active
</span><span class='line'>$ bundle exec knife rackspace server delete 42899699-68e7-4785-9f49-e0050f86249a --purge</span></code></pre></td></tr></table></div></figure>


<h2>Create the Deis Controller server</h2>

<h3>Launch the Server</h3>

<p>Launch the server from the image you created earlier:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nova image-list | grep  deis-base-image
</span><span class='line'>| a58c9895-6349-442a-bba7-99611900209d | deis-base-image
</span><span class='line'>$ knife rackspace server create \
</span><span class='line'>  --image a58c9895-6349-442a-bba7-99611900209d \
</span><span class='line'>  --rackspace-metadata "{\"Name\": \"deis-controller\"}" \
</span><span class='line'>  --rackspace-disk-config MANUAL \
</span><span class='line'>  --server-name deis-controller \
</span><span class='line'>  --node-name deis-controller \
</span><span class='line'>  --flavor 'performance1-2'
</span><span class='line'>Instance ID: bb713170-9322-424a-8837-863a4b396705
</span><span class='line'>Name: deis-controller
</span><span class='line'>Flavor: 2 GB Performance
</span><span class='line'>Image: deis-base-image
</span><span class='line'>...
</span><span class='line'>Public IP Address: 23.253.104.13
</span><span class='line'>Private IP Address: 10.208.132.190
</span><span class='line'>Password: CQwDU4m97nvF</span></code></pre></td></tr></table></div></figure>


<p>Take note of the <code>Instance ID</code> and <code>Public IP Address</code>.</p>

<p>If you have an easy to manage domain add an A record for <code>deis</code> to it for the Public IP address.  If not
add an entry to your hosts file ( or do both! I did ):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo sh -c "echo '&lt;IP_OF_SERVER&gt; deis' &gt;&gt; /etc/hosts"</span></code></pre></td></tr></table></div></figure>


<h3>Modify Chef Admin Group</h3>

<p>On the Chef management website click (https://manage.opscode.com/groups/admins/edit)[Groups] and add the <code>deis-controller</code> client and your validator client to the <code>admins</code> group.</p>

<p><img src="https://lh5.googleusercontent.com/-oSqB1Tdnn4c/UwpioPAXpJI/AAAAAAAANz4/xa8BdmRuTzQ/w579-h580-no/chef-admins.png" alt="chef admins group" /></p>

<h3>Converge the Deis Controller Server</h3>

<p>Edit the <code>deis-controller</code> node via this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ EDITOR=vi knife node edit deis-controller</span></code></pre></td></tr></table></div></figure>


<p>make it look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "name": "deis-controller",
</span><span class='line'>  "chef_environment": "_default",
</span><span class='line'>  "normal": {
</span><span class='line'>    "tags": [
</span><span class='line'>
</span><span class='line'>    ]
</span><span class='line'>  },
</span><span class='line'>  "run_list": [
</span><span class='line'>    "recipe[deis::controller]"
</span><span class='line'>  ]
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>then converge the node by running chef client on it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh deis-ops@deis sudo chef-client
</span><span class='line'>[2014-02-23T19:25:32+00:00] INFO: Forking chef instance to converge...
</span><span class='line'>[2014-02-23T19:25:32+00:00] INFO: *** Chef 11.6.2 ***
</span><span class='line'>[2014-02-23T19:25:33+00:00] INFO: Run List is [recipe[deis::controller]]
</span><span class='line'>[2014-02-23T19:25:33+00:00] INFO: Run List expands to [deis::controller]
</span><span class='line'>[2014-02-23T19:25:33+00:00] INFO: Starting Chef Run for deis-controller
</span><span class='line'>[2014-02-23T19:25:33+00:00] INFO: Running start handlers
</span><span class='line'>[2014-02-23T19:25:33+00:00] INFO: Start handlers complete.
</span><span class='line'>...
</span><span class='line'>$</span></code></pre></td></tr></table></div></figure>


<h2>Testing Deis</h2>

<h3>Install the Deis Client with pip</h3>

<p>The Deis client is written in python and can be installed by <code>pip</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo pip install deis  </span></code></pre></td></tr></table></div></figure>


<h3>Register Admin User</h3>

<p>First user to register becomes the Admin:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis register http://deis:8000
</span><span class='line'>username: admin
</span><span class='line'>password: 
</span><span class='line'>password (confirm): 
</span><span class='line'>email: admin@example.com
</span><span class='line'>Registered admin
</span><span class='line'>Logged in as admin</span></code></pre></td></tr></table></div></figure>


<p>Push your public key to deis:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis keys:add ~/.ssh/id_rsa.pub 
</span><span class='line'>Uploading SSH_KEY to Deis...done</span></code></pre></td></tr></table></div></figure>


<p>check the web server is serving content by browsing to (http://deis)[http://deis] and entering your admin credentials.</p>

<h3>Teach Deis your provider credentials</h3>

<p>Deis will automatically provision worker nodes if you teach it your credentials.</p>

<p>We already have our Rackspace credentials saved to <code>~/paas/.chef/openrc</code> but Deis wants them named differently:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export RACKSPACE_USERNAME=$OS_USERNAME
</span><span class='line'>$ export RACKSPACE_API_KEY=$OS_PASSWORD
</span><span class='line'>$ deis providers:discover
</span><span class='line'>No EC2 credentials discovered.
</span><span class='line'>Discovered Rackspace credentials: ****************
</span><span class='line'>Import Rackspace credentials? (y/n) : y
</span><span class='line'>Uploading Rackspace credentials... done
</span><span class='line'>No DigitalOcean credentials discovered.
</span><span class='line'>No Vagrant VMs discovered.</span></code></pre></td></tr></table></div></figure>


<h2>Deploy Formations &amp; Layers</h2>

<h3>Formation</h3>

<p>Formations are collections of infrastructure for serving applications.   We&#8217;ll call our first Formation <code>dev</code> for development.</p>

<p>Create formation (using the wildcard domain from our cloud load balancer created earlier in the <code>--domain</code> argument):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis formations:create dev --domain=50.56.167.26.xip.io
</span><span class='line'>Creating formation... done, created dev
</span><span class='line'>See `deis help layers:create` to begin building your formation</span></code></pre></td></tr></table></div></figure>


<h3>Layers</h3>

<p>Layers are a heterogenerous collection of nodes that perform one of two function:</p>

<ol>
<li>Proxy - Directs traffic to the appropriate container running the application.</li>
<li>Runtime - Runs the containers that hold the applications.</li>
</ol>


<p>We&#8217;re going to create a layer called <code>nodes</code> that will perform both the proxy and runtime functions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis layers:create dev nodes rackspace-dfw --proxy=y --runtime=y
</span><span class='line'>Creating nodes layer... done in 4s</span></code></pre></td></tr></table></div></figure>


<p><em>note</em> There&#8217;s currently a <a href="https://github.com/opdemand/deis/issues/541">bug</a> that causes the first creation of a layer to fail.  if that happens run the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deis formations:create dev --domain=50.56.167.26.xip.io
</span><span class='line'>Creating formation... done, created dev
</span><span class='line'>
</span><span class='line'>See `deis help layers:create` to begin building your formation
</span><span class='line'>$ deis layers:create dev nodes rackspace-dfw --proxy=y --runtime=y
</span><span class='line'>Creating nodes layer... 500 INTERNAL SERVER ERROR
</span><span class='line'>&lt;h1&gt;Server Error (500)&lt;/h1&gt;
</span><span class='line'>$ deis layers:destroy dev nodes
</span><span class='line'>Destroying nodes layer... done in 0s
</span><span class='line'>$ deis layers:create dev nodes rackspace-dfw --proxy=y --runtime=y
</span><span class='line'>Creating nodes layer... done in 2s
</span></code></pre></td></tr></table></div></figure>


<h3>Build Nodes</h3>

<p>Next we tell deis to spin up two Cloud Servers which will become members of the <code>nodes</code> layer.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis nodes:scale dev nodes=2
</span><span class='line'>Scaling nodes... but first, coffee!
</span><span class='line'>done in 345s
</span><span class='line'>Use `deis create --formation=dev` to create an application</span></code></pre></td></tr></table></div></figure>


<p>This can sometimes take longer than the <code>deis</code> cli timeout.   Don&#8217;t fear,  just wait a bit longer, this could be a great time to explore the <code>deis</code> cli by running <code>deis help</code>.</p>

<h2>Update Cloud Load Balancer</h2>

<p>Add these two nodes to the (https://mycloud.rackspace.com/load_balancers)[Cloud Load Balancer] we created earlier.</p>

<p><img src="https://lh6.googleusercontent.com/-yaJfxoyDk4M/UwpioEndiOI/AAAAAAAANz0/aXannmisdbE/w903-h407-no/cloud-servers-list.png" alt="cloud server list" /></p>

<p>This is simple to do through the GUI:</p>

<ul>
<li>Click on your load balancer and under <code>Nodes</code> click the <code>Add Cloud Servers</code> button.</li>
<li>Check the box beside the two <code>dev-nodes</code> servers and click <code>Add Selected Servers</code>.</li>
</ul>


<p><img src="https://lh6.googleusercontent.com/-zm6sB7l7YVk/Uwpin4BNJPI/AAAAAAAANzw/b-_J2ieyIuE/w773-h476-no/cloud-lb-nodes.png" alt="cloud lb servers" /></p>

<h2>Deploy an Application</h2>

<p>So great, you have a PaaS, but what do you do now?  Deploy some apps of course!</p>

<h3>NodeJS Example App</h3>

<p>Download the NodeJS example application so like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p ~/paas/apps
</span><span class='line'>$ cd ~paas/apps
</span><span class='line'>$ git clone https://github.com/opdemand/example-nodejs-express.git
</span><span class='line'>$ cd example-nodejs-express</span></code></pre></td></tr></table></div></figure>


<h3>Create an Application in Deis</h3>

<p>Use the Deis command line tool to create a new application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis create      
</span><span class='line'>Creating application... done, created exotic-sandwich
</span><span class='line'>Git remote deis added</span></code></pre></td></tr></table></div></figure>


<h3>Push your Application to Deis</h3>

<p>This will push, deploy and Launch the app.  The first one will take some time as deis has to download some docker images,  subsequent apps will be much faster:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git push deis master                     
</span><span class='line'>git push deis master
</span><span class='line'>Counting objects: 184, done.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% (89/89), done.
</span><span class='line'>Writing objects: 100% (184/184), 28.77 KiB | 0 bytes/s, done.
</span><span class='line'>Total 184 (delta 103), reused 165 (delta 92)
</span><span class='line'>-----&gt; Node.js app detected
</span><span class='line'>-----&gt; Requested node range: 0.10.x
</span><span class='line'>-----&gt; Resolved node version: 0.10.26
</span><span class='line'>-----&gt; Downloading and installing node
</span><span class='line'>-----&gt; Installing dependencies
</span><span class='line'>       npm WARN package.json example-nodejs-express@0.0.1 No repository field.
</span><span class='line'>       npm http GET https://registry.npmjs.org/express
</span><span class='line'>       npm http 200 https://registry.npmjs.org/express
</span><span class='line'>...
</span><span class='line'>-----&gt; Caching node_modules directory for future builds
</span><span class='line'>-----&gt; Cleaning up node-gyp and npm artifacts
</span><span class='line'>-----&gt; Building runtime environment
</span><span class='line'>-----&gt; Discovering process types
</span><span class='line'>       Procfile declares types -&gt; web
</span><span class='line'>-----&gt; Compiled slug size is 5.5M
</span><span class='line'>-----&gt; Building Docker image
</span><span class='line'>Uploading context 5.698 MB
</span><span class='line'>Uploading context 
</span><span class='line'>Step 0 : FROM deis/slugrunner
</span><span class='line'> ---&gt; bb0a27915014
</span><span class='line'>Step 1 : RUN mkdir -p /app
</span><span class='line'> ---&gt; Running in 1ae5cdeaad9a
</span><span class='line'> ---&gt; 6e6467466d48
</span><span class='line'>Step 2 : ADD slug.tgz /app
</span><span class='line'> ---&gt; 191a4345b1e4
</span><span class='line'>Step 3 : ENTRYPOINT ["/runner/init"]
</span><span class='line'> ---&gt; Running in d322512d5865
</span><span class='line'> ---&gt; 2866cf3e37c9
</span><span class='line'>Successfully built 2866cf3e37c9
</span><span class='line'>-----&gt; Pushing image to private registry
</span><span class='line'>       Launching... done, v2
</span><span class='line'>
</span><span class='line'>-----&gt; exotic-sandwich deployed to Deis
</span><span class='line'>       http://exotic-sandwich.50.56.167.26.xip.io
</span><span class='line'>
</span><span class='line'>       To learn more, use `deis help` or visit http://deis.io
</span><span class='line'>
</span><span class='line'>To ssh://git@deis:2222/exotic-sandwich.git
</span><span class='line'> * [new branch]      master -&gt; master
</span></code></pre></td></tr></table></div></figure>


<h2>Did it work ?</h2>

<p>Open your web browser to the URL in the output of the previous command.  In my case this was <code>http://exotic-sandwich.50.56.167.26.xip.io</code>.</p>

<p>If everything worked the text in the browser window should read <code>Powered by Deis</code>.</p>

<p><img src="https://lh6.googleusercontent.com/-cxuysxM_oM8/UwpipfiKFMI/AAAAAAAAN0U/M7T9dC6xJ-E/w446-h171-no/deis-app-1.png" alt="deis app" /></p>

<h2>Configure and Scale your application</h2>

<p>We can set config parameters for our apps by running <code>deis config</code>.   The example app we&#8217;re using has a config paramater &#8216;POWERED_BY&#8217; so we can set that by running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis config:set POWERED_BY='DEIS and Rackspace'
</span><span class='line'>=== exotic-sandwich
</span><span class='line'>POWERED_BY: DEIS and Rackspace</span></code></pre></td></tr></table></div></figure>


<p><img src="https://lh6.googleusercontent.com/-J5AcNytZLOQ/UwpipEdpeBI/AAAAAAAAN0E/WXWC08rxsBU/w507-h157-no/deis-app-2.png" alt="deis app2" /></p>

<p>Expecting visitors?  Let&#8217;s scale your app to 5 nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis scale web=5
</span><span class='line'>Scaling containers... but first, coffee!
</span><span class='line'>done in 54s
</span><span class='line'>
</span><span class='line'>=== exotic-sandwich Containers
</span><span class='line'>
</span><span class='line'>--- web: `node server.js`
</span><span class='line'>web.1 up 2014-02-23T20:22:07.241Z (dev-nodes-2)
</span><span class='line'>web.2 up 2014-02-23T20:28:21.778Z (dev-nodes-1)
</span><span class='line'>web.3 up 2014-02-23T20:28:21.788Z (dev-nodes-2)
</span><span class='line'>web.4 up 2014-02-23T20:28:21.799Z (dev-nodes-1)
</span><span class='line'>web.5 up 2014-02-23T20:28:21.810Z (dev-nodes-2)</span></code></pre></td></tr></table></div></figure>


<p>You can see what your app is doing by running <code>deis info</code> and <code>deis logs</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis info
</span><span class='line'>=== exotic-sandwich Application
</span><span class='line'>{
</span><span class='line'>  "updated": "2014-02-23T20:28:21.812Z", 
</span><span class='line'>  "uuid": "ef618db6-f5a8-4cab-a7d9-d01e78036e3a", 
</span><span class='line'>  "created": "2014-02-23T20:16:51.931Z", 
</span><span class='line'>  "formation": "dev", 
</span><span class='line'>  "owner": "admin", 
</span><span class='line'>  "id": "exotic-sandwich", 
</span><span class='line'>  "containers": "{\"web\": 5}"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>=== exotic-sandwich Containers
</span><span class='line'>
</span><span class='line'>--- web: `node server.js`
</span><span class='line'>web.1 up 2014-02-23T20:22:07.241Z (dev-nodes-2)
</span><span class='line'>web.2 up 2014-02-23T20:28:21.778Z (dev-nodes-1)
</span><span class='line'>web.3 up 2014-02-23T20:28:21.788Z (dev-nodes-2)
</span><span class='line'>web.4 up 2014-02-23T20:28:21.799Z (dev-nodes-1)
</span><span class='line'>web.5 up 2014-02-23T20:28:21.810Z (dev-nodes-2)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis logs
</span><span class='line'>Feb 23 20:22:57 dev-nodes exotic-sandwich[web.1]: Server listening on port 10001 in development mode
</span><span class='line'>Feb 23 20:25:38 dev-nodes exotic-sandwich[web.1]: Server listening on port 10001 in development mode
</span><span class='line'>Feb 23 20:26:49 dev-nodes exotic-sandwich[web.1]: Server listening on port 10001 in development mode
</span><span class='line'>Feb 23 20:28:28 dev-nodes exotic-sandwich[web.3]: Server listening on port 10003 in development mode
</span><span class='line'>Feb 23 20:28:29 dev-nodes exotic-sandwich[web.5]: Server listening on port 10005 in development mode
</span><span class='line'>Feb 23 20:29:11 dev-nodes exotic-sandwich[web.2]: Server listening on port 10002 in development mode
</span><span class='line'>Feb 23 20:29:12 dev-nodes exotic-sandwich[web.4]: Server listening on port 10004 in development mode</span></code></pre></td></tr></table></div></figure>


<p>Congratulations!  You&#8217;ve successfully built out your own cost effective PAAS and deployed your first application to it.</p>

<p>Speaking of costs &#8230;  How much would this cost to run per month ?</p>

<ul>
<li>Cloud Load Balancer - $10.95 / month</li>
<li>Deis Controller - $57.60 / month</li>
<li>Deis Nodes (x2) - $115.20 / month</li>
</ul>


<p>Total:  $183.75 / month.</p>

<p>You could run all of this on a single server without a load balancer,  which means it would be just $57.60/month, which with the <a href="http://developer.rackspace.com/devtrial/">Rackspace Developer Discount</a> would reduce down to just $7.60/month.</p>

<h1>Epilogue</h1>

<h2>Cleanup</h2>

<p>Destroy your app:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ deis destroy
</span><span class='line'>
</span><span class='line'> !    WARNING: Potentially Destructive Action
</span><span class='line'> !    This command will destroy the application: exotic-sandwich
</span><span class='line'> !    To proceed, type "exotic-sandwich" or re-run this command with --confirm=exotic-sandwich
</span><span class='line'>
</span><span class='line'>&gt; exotic-sandwich
</span><span class='line'>Destroying exotic-sandwich... done in 21s
</span><span class='line'>Git remote deis removed</span></code></pre></td></tr></table></div></figure>


<p>list your servers:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle exec knife rackspace server list
</span><span class='line'>Instance ID                           Name             Public IP       Private IP      Flavor          Image                                 State 
</span><span class='line'>7c43ecb9-1ba3-454c-a5f4-637b56961d68  dev-nodes        23.253.102.184  10.208.135.137  performance1-2  2d59cbce-92fa-412b-8a5e-6eb426ce7dc9  active
</span><span class='line'>f89c4b25-6486-422a-907a-16b3b3223a5e  dev-nodes        23.253.102.158  10.208.137.18   performance1-2  2d59cbce-92fa-412b-8a5e-6eb426ce7dc9  active
</span><span class='line'>bb713170-9322-424a-8837-863a4b396705  deis-controller  23.253.104.13   10.208.132.190  performance1-2  a58c9895-6349-442a-bba7-99611900209d  active</span></code></pre></td></tr></table></div></figure>


<p>Delete your servers by running the following command for each:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle exec knife rackspace server delete 7c43ecb9-1ba3-454c-a5f4-637b56961d68 --purge
</span><span class='line'>Instance ID: 7c43ecb9-1ba3-454c-a5f4-637b56961d68
</span><span class='line'>Host ID: e0da0172f321babe99aec9686c7b99ac7fa5ff8fa1ada934f5fae842
</span><span class='line'>Name: dev-nodes
</span><span class='line'>Flavor: 2 GB Performance
</span><span class='line'>Image: deis-node-image
</span><span class='line'>Public IP Address: 23.253.102.184
</span><span class='line'>Private IP Address: 10.208.135.137
</span><span class='line'>
</span><span class='line'>Do you really want to delete this server? (Y/N) y
</span><span class='line'>[WARNING] Error Parsing response json - Yajl::ParseError
</span><span class='line'>WARNING: Deleted server 7c43ecb9-1ba3-454c-a5f4-637b56961d68</span></code></pre></td></tr></table></div></figure>


<p>Clean up your chef:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bundle exec knife data bag delete deis-apps
</span><span class='line'>$ bundle exec knife data bag delete deis-formations
</span><span class='line'>$ bundle exec knife client delete dev-nodes-1
</span><span class='line'>$ bundle exec knife client delete dev-nodes-2
</span><span class='line'>$ bundle exec knife node delete dev-nodes-1
</span><span class='line'>$ bundle exec knife node delete dev-nodes-2</span></code></pre></td></tr></table></div></figure>


<p>Delete your glance images:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nova image-delete deis-base-image
</span><span class='line'>$ nova image-delete deis-node-image</span></code></pre></td></tr></table></div></figure>


<p>Finally delete your Cloud Load Balancer from the <a href="https://mycloud.rackspace.com/load_balancers">Rackspace UI</a></p>
</div>

<div class="meta">
	
		<span class="comments"><a href="/2014/02/running-deis-io-on-rackspace-cloud.html#disqus_thread">Comments</a></span>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2014

    Paul Czarkowski
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'tech-paulcz';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://paulczar.github.com/2014/02/running-deis-io-on-rackspace-cloud.html';
        var disqus_url = 'http://paulczar.github.com/2014/02/running-deis-io-on-rackspace-cloud.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
